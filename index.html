<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Mage God: Camera Fix</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', Courier, monospace; }
        
        /* UI UTAMA */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        
        /* TOMBOL MULAI (PENTING BUAT IZIN KAMERA) */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 50;
            pointer-events: auto; /* Bisa diklik */
        }
        #start-btn {
            padding: 20px 50px; font-size: 24px; font-weight: bold; color: #00ffff;
            background: transparent; border: 2px solid #00ffff; border-radius: 10px;
            cursor: pointer; box-shadow: 0 0 20px #00ffff; transition: 0.2s;
            text-transform: uppercase; letter-spacing: 2px;
        }
        #start-btn:hover { background: #00ffff; color: #000; }
        #error-msg { margin-top: 20px; color: red; font-size: 16px; display: none; }

        /* HUD */
        #gesture-display {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            font-size: 32px; font-weight: bold; color: yellow; text-shadow: 0 0 10px orange;
        }
        #skill-icons {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px;
        }
        .icon {
            width: 60px; height: 60px; border: 1px solid #555; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 24px;
            background: rgba(0,0,0,0.5); color: #555; transition: 0.2s;
        }
        .icon.active { transform: scale(1.2); border-color: white; color: white; box-shadow: 0 0 15px white; }
        
        /* DETECT STATUS COLORS */
        #s-fire.active { background: #551100; box-shadow: 0 0 20px #ff5500; }
        #s-thunder.active { background: #220033; box-shadow: 0 0 20px #aa00ff; }
        #s-ice.active { background: #002233; box-shadow: 0 0 20px #00ffff; }
        #s-void.active { background: #111; box-shadow: 0 0 20px #ffffff; }
        #s-solar.active { background: #332200; box-shadow: 0 0 20px #ffdd00; }

        #video-preview {
            position: absolute; bottom: 10px; right: 10px; width: 160px; height: 120px;
            border: 1px solid cyan; opacity: 0.5; z-index: 5; transform: scaleX(-1);
        }
        video { width: 100%; height: 100%; object-fit: cover; }

    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
</head>
<body>

    <div id="start-screen">
        <h1>ELEMENTAL HAND TRACKING</h1>
        <button id="start-btn" onclick="startGame()">AKTIFKAN KAMERA & MULAI</button>
        <div id="error-msg"></div>
        <p style="color: #888; margin-top: 20px; font-size: 12px;">Pastikan cahaya ruangan cukup terang</p>
    </div>

    <div id="ui-layer">
        <div id="gesture-display">MENUNGGU...</div>
        <div id="skill-icons">
            <div id="s-fire" class="icon">‚úä<br><small>Fire</small></div>
            <div id="s-thunder" class="icon">‚òùÔ∏è<br><small>Bolt</small></div>
            <div id="s-ice" class="icon">üñêÔ∏è<br><small>Ice</small></div>
            <div id="s-void" class="icon">‚úåÔ∏è<br><small>Void</small></div>
            <div id="s-solar" class="icon">ü§ü<br><small>Sun</small></div>
        </div>
    </div>

    <div id="video-preview"><video id="input_video" playsinline></video></div>

    <script>
        // --- CONFIG ---
        let isGameActive = false;
        
        // --- 1. THREE.JS SETUP ---
        const scene = new THREE.Scene();
        // Fog dikurangi biar musuh kelihatan dari jauh
        scene.fog = new THREE.FogExp2(0x000000, 0.015); 

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1, 5);

        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.body.appendChild(renderer.domElement);

        // BLOOM (GLOW EFFECT)
        const composer = new THREE.EffectComposer(renderer);
        composer.addPass(new THREE.RenderPass(scene, camera));
        const bloom = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloom.strength = 1.8; bloom.radius = 0.5; bloom.threshold = 0;
        composer.addPass(bloom);

        // LIGHTING
        scene.add(new THREE.AmbientLight(0x404040)); // Cahaya dasar biar ga hitam pekat
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
        dirLight.position.set(0, 10, 0);
        scene.add(dirLight);

        // LANTAI GRID
        const grid = new THREE.GridHelper(200, 50, 0x555555, 0x111111);
        grid.position.y = -2;
        scene.add(grid);

        // --- 2. GAME VARIABLES ---
        let handPos = new THREE.Vector3(0,0,3);
        let gesture = 'NONE';
        let projectiles = [];
        let enemies = [];
        let frameCount = 0;
        let shakeIntensity = 0;

        // Visual Tangan (Orb)
        const handOrb = new THREE.Mesh(
            new THREE.SphereGeometry(0.2, 16, 16),
            new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true })
        );
        scene.add(handOrb);

        // --- 3. CLASSES ---

        class Projectile {
            constructor(type, pos) {
                this.type = type;
                this.active = true;
                this.pos = pos.clone();
                this.vel = new THREE.Vector3(0, 0, -0.8); // Maju ke depan

                let color = 0xffffff;
                let size = 1;

                if (type === 'FIRE') { color = 0xff5500; size = 1.5; }
                if (type === 'ICE') { 
                    color = 0x00ffff; size = 0.5; 
                    this.vel.x = (Math.random()-0.5)*0.5; // Spread
                    this.vel.y = (Math.random()-0.5)*0.5;
                }
                if (type === 'VOID') { color = 0xaa00ff; size = 2.0; this.vel.z = -0.3; }

                // Visual Simple Glowing Sphere
                const geo = new THREE.SphereGeometry(size, 8, 8);
                const mat = new THREE.MeshBasicMaterial({ color: color });
                this.mesh = new THREE.Mesh(geo, mat);
                this.mesh.position.copy(this.pos);
                scene.add(this.mesh);

                // Light attached to projectile
                this.light = new THREE.PointLight(color, 1, 10);
                this.mesh.add(this.light);
            }

            update() {
                this.pos.add(this.vel);
                this.mesh.position.copy(this.pos);
                
                // Putar-putar untuk void
                if(this.type === 'VOID') {
                    this.mesh.rotation.z += 0.1;
                    // Logic hisap musuh
                    enemies.forEach(e => {
                        if(e.mesh.position.distanceTo(this.pos) < 8) {
                            e.mesh.position.lerp(this.pos, 0.05);
                        }
                    });
                }

                if(this.pos.z < -100) this.kill();
            }

            kill() {
                this.active = false;
                scene.remove(this.mesh);
            }
        }

        class Enemy {
            constructor() {
                // MATERIAL MUSUH YANG PASTI KELIHATAN (EMISSIVE + WIREFRAME)
                const geo = new THREE.IcosahedronGeometry(1, 0);
                const mat = new THREE.MeshBasicMaterial({ 
                    color: 0xff0000, // Merah terang
                    wireframe: true  // Mode jaring-jaring biar kelihatan sci-fi
                });
                
                // Tambahkan inti biar solid (biar ga tembus pandang banget)
                const coreGeo = new THREE.IcosahedronGeometry(0.8, 0);
                const coreMat = new THREE.MeshBasicMaterial({ color: 0x330000 });
                
                this.mesh = new THREE.Group();
                const wireframe = new THREE.Mesh(geo, mat);
                const core = new THREE.Mesh(coreGeo, coreMat);
                
                this.mesh.add(core);
                this.mesh.add(wireframe);

                // Spawn agak dekat (-50) jangan -100 kejauhan
                this.mesh.position.set(
                    (Math.random()-0.5) * 30,
                    (Math.random()-0.5) * 10,
                    -50 
                );
                
                scene.add(this.mesh);
                this.speed = 0.15 + Math.random() * 0.1;
            }

            update() {
                this.mesh.position.z += this.speed;
                this.mesh.rotation.x += 0.02;
                this.mesh.rotation.y += 0.02;

                if (this.mesh.position.z > 2) {
                    // Kena Player
                    shakeCamera(0.5);
                    this.kill();
                }
            }

            hit() {
                // Efek partikel sederhana pas mati
                this.kill();
            }

            kill() {
                scene.remove(this.mesh);
                enemies.splice(enemies.indexOf(this), 1);
            }
        }

        // --- 4. GAME LOGIC ---

        function fireSkill() {
            if (gesture === 'FIST' && frameCount % 8 === 0) { // FIRE
                projectiles.push(new Projectile('FIRE', handPos));
                shakeCamera(0.1);
            }
            else if (gesture === 'OPEN' && frameCount % 15 === 0) { // ICE
                for(let i=0; i<3; i++) projectiles.push(new Projectile('ICE', handPos));
                shakeCamera(0.1);
            }
            else if (gesture === 'VICTORY' && frameCount % 40 === 0) { // VOID
                projectiles.push(new Projectile('VOID', handPos));
            }
            else if (gesture === 'INDEX') { // THUNDER (Instant)
                castRay(0xaa00ff);
            }
            else if (gesture === 'ROCK') { // SOLAR (Instant)
                castRay(0xffdd00);
            }
        }

        function castRay(color) {
            // Visual Beam
            const points = [handPos, new THREE.Vector3(0,0,-50)];
            const geo = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(geo, new THREE.LineBasicMaterial({ color: color }));
            scene.add(line);
            setTimeout(() => scene.remove(line), 30);
            shakeCamera(0.05);

            // Kill Logic (Sangat sederhana: musuh di tengah layar mati)
            enemies.forEach(e => {
                if (Math.abs(e.mesh.position.x) < 5 && Math.abs(e.mesh.position.y) < 5) {
                    e.hit();
                }
            });
        }

        function shakeCamera(amount) { shakeIntensity = amount; }

        // --- 5. CAMERA & MEDIAPIPE SETUP (CRITICAL FIX) ---

        async function startGame() {
            const btn = document.getElementById('start-btn');
            const msg = document.getElementById('error-msg');
            btn.innerText = "MEMUAT SISTEM...";
            btn.disabled = true;

            try {
                // Minta izin kamera secara eksplisit
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                
                // Jika berhasil, matikan stream (MediaPipe akan membukanya sendiri atau pakai stream ini)
                // Kita setup MediaPipe sekarang
                setupMediaPipe();
                
                // Hide start screen
                document.getElementById('start-screen').style.display = 'none';
                isGameActive = true;
                animate();

            } catch (err) {
                console.error(err);
                btn.innerText = "GAGAL AKSES KAMERA";
                msg.style.display = 'block';
                msg.innerText = "Error: Browser memblokir kamera. Pastikan klik 'Allow' atau buka di localhost/https.";
                btn.disabled = false;
            }
        }

        function setupMediaPipe() {
            const videoElement = document.getElementById('input_video');
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.6,
                minTrackingConfidence: 0.6
            });

            hands.onResults(onResults);

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 640, height: 480
            });
            cameraUtils.start();
        }

        // GESTURE RECOGNITION LOGIC
        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                
                // Convert hand position
                handPos.set( (1 - lm[9].x - 0.5) * 15, (1 - lm[9].y - 0.5) * 10, 2 );
                handOrb.position.copy(handPos);

                // Simple Gesture Logic
                const thumbUp = lm[4].x < lm[3].x;
                const indexUp = lm[8].y < lm[6].y;
                const midUp = lm[12].y < lm[10].y;
                const ringUp = lm[16].y < lm[14].y;
                const pinkyUp = lm[20].y < lm[18].y;

                let fingers = 0;
                if(indexUp) fingers++; if(midUp) fingers++; if(ringUp) fingers++; if(pinkyUp) fingers++;

                if (fingers === 0) gesture = 'FIST';
                else if (fingers >= 4) gesture = 'OPEN';
                else if (indexUp && !midUp && !ringUp && !pinkyUp) gesture = 'INDEX';
                else if (indexUp && midUp && !ringUp && !pinkyUp) gesture = 'VICTORY';
                else if (indexUp && pinkyUp && !midUp && !ringUp) gesture = 'ROCK';
                else gesture = 'NONE';

                updateUI(gesture);
            } else {
                gesture = 'NONE';
                updateUI('NONE');
            }
        }

        function updateUI(g) {
            document.getElementById('gesture-display').innerText = g;
            document.querySelectorAll('.icon').forEach(el => el.classList.remove('active'));
            if(g === 'FIST') document.getElementById('s-fire').classList.add('active');
            if(g === 'INDEX') document.getElementById('s-thunder').classList.add('active');
            if(g === 'OPEN') document.getElementById('s-ice').classList.add('active');
            if(g === 'VICTORY') document.getElementById('s-void').classList.add('active');
            if(g === 'ROCK') document.getElementById('s-solar').classList.add('active');
        }

        // --- 6. MAIN LOOP ---
        function animate() {
            if(!isGameActive) return;
            requestAnimationFrame(animate);
            frameCount++;

            // Spawn Enemies
            if(Math.random() < 0.04) new Enemy();

            // Run Skill
            fireSkill();

            // Updates
            projectiles.forEach(p => p.update());
            
            for(let i=enemies.length-1; i>=0; i--) {
                enemies[i].update();
                // Collision
                projectiles.forEach(p => {
                    if(p.active && p.mesh.position.distanceTo(enemies[i].mesh.position) < 2.5) {
                        enemies[i].hit();
                        if(p.type !== 'VOID') p.kill();
                    }
                });
            }

            // Camera Shake
            if(shakeIntensity > 0) {
                camera.position.x = (Math.random()-0.5) * shakeIntensity;
                camera.position.y = 1 + (Math.random()-0.5) * shakeIntensity;
                shakeIntensity *= 0.9;
            } else {
                camera.position.set(0, 1, 5);
            }

            composer.render();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
